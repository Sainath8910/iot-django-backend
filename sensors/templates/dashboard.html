{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html class="dark" lang="en">

<body class="bg-background-dark text-white font-display overflow-hidden">

<div class="flex h-screen">

<!-- ================= MAIN ================= -->
<main class="flex-1 flex flex-col">


<div class="flex-1 overflow-y-auto p-6 space-y-8">

<!-- ================= KPI CARDS ================= -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">

<div class="bg-card-dark border border-border-dark rounded-xl p-6">
  <p class="text-text-secondary flex gap-1">
    <span class="material-symbols-outlined">thermostat</span> Temperature
  </p>
  <h3 id="tempValue" class="text-3xl font-bold mt-2">--°C</h3>
  <canvas id="tempChart" class="h-24 mt-4"></canvas>
</div>

<div class="bg-card-dark border border-border-dark rounded-xl p-6">
  <p class="text-text-secondary flex gap-1">
    <span class="material-symbols-outlined">water_drop</span> Humidity
  </p>
  <h3 id="humidValue" class="text-3xl font-bold mt-2">--%</h3>
  <canvas id="humidChart" class="h-24 mt-4"></canvas>
</div>

<div class="bg-card-dark border border-border-dark rounded-xl p-6">
  <p class="text-text-secondary flex gap-1">
    <span class="material-symbols-outlined">potted_plant</span> Soil Moisture
  </p>
  <h3 id="soilValue" class="text-3xl font-bold mt-2">--%</h3>
  <canvas id="soilChart" class="h-24 mt-4"></canvas>
</div>

<div class="bg-card-dark border border-border-dark rounded-xl p-6">
  <p class="text-text-secondary flex gap-1">
    <span class="material-symbols-outlined">science</span> pH Level
  </p>
  <h3 id="phValue" class="text-3xl font-bold mt-2">--</h3>
  <canvas id="phChart" class="h-24 mt-4"></canvas>
</div>

</div>

<div id="aiBanner" class="hidden bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-red-400 font-semibold">
  ⚠ AI ALERT: Crop is under severe risk
</div>
<!-- ================= TABLE ================= -->
<div class="bg-card-dark border border-border-dark rounded-xl overflow-hidden">
<table class="w-full text-center">
<thead class="bg-[#1e3419]">
<tr>
  <th class="p-4 text-xs text-text-secondary">Time</th>
  <th class="p-4 text-xs text-text-secondary">Device</th>
  <th class="p-4 text-xs text-text-secondary">Image</th>
  <th class="p-4 text-xs text-text-secondary">Disease</th>
  <th class="p-4 text-xs text-text-secondary">Stress</th>
  <th class="p-4 text-xs text-text-secondary">Status</th>
</tr>
</thead>
<tbody id="tableBody" class="divide-y divide-border-dark text-sm"></tbody>
</table>
</div>

</div>
</main>
</div>

<!-- ================= SCRIPT ================= -->
<script>
let tempChart, humidChart, soilChart, phChart;

const profileBtn = document.getElementById("profileBtn");
const profileMenu = document.getElementById("profileMenu");
const aiBanner = document.getElementById("aiBanner");

profileBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  profileMenu.classList.toggle("hidden");
});

document.addEventListener("click", () => {
  profileMenu.classList.add("hidden");
});

function createChart(id) {
  return new Chart(document.getElementById(id), {
    type: "line",
    data: {
      labels: [],
      datasets: [{ data: [], borderWidth: 2, tension: 0.4 }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { x: { display: false }, y: { display: false } }
    }
  });
}

tempChart = createChart("tempChart");
humidChart = createChart("humidChart");
soilChart = createChart("soilChart");
phChart = createChart("phChart");
function openCase(id) {
  window.location = `/analysis/?reading=${id}`;
}
function updateDashboard() {
  fetch("/latest/")
    .then(res => res.json())
    .then(data => {
      if (!data.length) return;

      let labels = [], t = [], h = [], s = [], p = [], rows = "";

      data.forEach(r => {
        labels.push(r.time);
        t.push(r.temperature);
        h.push(r.humidity);
        s.push(r.soil);
        p.push(r.ph);

        rows += `
        <tr class="hover:bg-white/5 cursor-pointer" onclick="openCase(${r.id})">
          <td class="p-4">${r.time}</td>

          <td class="p-4 text-xs text-text-secondary max-w-xs truncate" title="${r.decision}">
            ${r.device}
          </td>

          <td class="p-4 text-center">
            <div class="flex justify-center items-center">
              <img src="${r.image}"
                  class="w-12 h-12 rounded-lg object-cover border border-border-dark"/>
            </div>
          </td>
          
          <td class="p-4 font-semibold ${r.disease.toLowerCase().includes("healthy") ? "text-primary" : "text-red-400"}">
            ${r.disease}
          </td>

          <td class="p-4 font-semibold ${r.stress === "High" ? "text-red-400" : "text-primary"}">
            ${r.stress}
          </td>

          <td class="p-4">
            <span class="px-3 py-1 rounded-full text-xs font-bold ${
              r.alert ? "bg-red-500/20 text-red-500" : "bg-primary/20 text-primary"
            }">
              ${r.alert ? "ALERT" : "NORMAL"}
            </span>
          </td>
        </tr>`;
      });

      tableBody.innerHTML = rows;

      const last = data[data.length - 1];

      tempValue.textContent = last.temperature + "°C";
      humidValue.textContent = last.humidity + "%";
      soilValue.textContent = last.soil + "%";
      phValue.textContent = last.ph;

      if (last.alert) {
        aiBanner.classList.remove("hidden");
        aiBanner.textContent = "⚠ " + last.decision;
      } else {
        aiBanner.classList.add("hidden");
      }

      [tempChart, humidChart, soilChart, phChart].forEach((c, i) => {
        c.data.labels = labels;
        c.data.datasets[0].data = [t, h, s, p][i];
        c.update();
      });
    });
}

setInterval(updateDashboard, 5000);
updateDashboard();
</script>
{% endblock %}