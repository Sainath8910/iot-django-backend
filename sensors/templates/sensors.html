{% extends "base.html" %}
{% block content %}

<main class="flex-1 flex flex-col h-full overflow-hidden relative">

  <!-- TILES -->
  <div class="flex-1 overflow-y-auto p-4 lg:p-6">
    <div class="max-w-7xl mx-auto">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <div onclick="openGraph('temperature','Temperature (°C)')" class="tile">
          <span class="material-symbols-outlined">thermostat</span>
          <p>Temperature</p>
          <h2>{{ reading.temperature|default:"--" }} °C</h2>
        </div>

        <div onclick="openGraph('humidity','Humidity (%)')" class="tile">
          <span class="material-symbols-outlined">water_drop</span>
          <p>Humidity</p>
          <h2>{{ reading.humidity|default:"--" }} %</h2>
        </div>

        <div onclick="openGraph('soil_moisture','Soil Moisture (%)')" class="tile">
          <span class="material-symbols-outlined">potted_plant</span>
          <p>Soil Moisture</p>
          <h2>{{ reading.soil_moisture|default:"--" }} %</h2>
        </div>

        <div onclick="openGraph('ph','pH Level')" class="tile">
          <span class="material-symbols-outlined">science</span>
          <p>pH Level</p>
          <h2>{{ reading.ph|default:"--" }}</h2>
        </div>

      </div>
    </div>
  </div>

  <!-- GRAPH MODAL -->
  <div id="graphModal"
       class="fixed inset-0 hidden bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">

    <div class="bg-[#0f1f14] w-full max-w-6xl rounded-2xl p-6">

      <!-- HEADER -->
      <div class="flex justify-between items-center mb-3">
        <h3 id="graphTitle" class="text-xl font-bold text-white"></h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-xl">✕</button>
      </div>

      <!-- DEVICE TOGGLES -->
      <div id="deviceToggles" class="flex flex-wrap gap-2 mb-4"></div>

      <!-- GRAPH -->
      <canvas id="graphCanvas" height="140"></canvas>
      <!-- TIME SCRUBBER -->
      <div class="mt-4">
        <input
          id="timeSlider"
          type="range"
          min="0"
          value="0"
          class="w-full accent-green-500 cursor-pointer"
          oninput="scrubTime(this.value)"
        />
        <div class="flex justify-between text-xs text-gray-400 mt-1">
          <span id="startLabel">Start</span>
          <span id="endLabel">End</span>
        </div>
      </div>

    </div>
  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
let chart;
let currentMetric = null;

let fullData = {};
let activeDevices = {};

let sliderIndex = 0;
const WINDOW_SIZE = 40;

function colorFor(i) {
  const colors = [
    "#49e619", "#3b82f6", "#f97316",
    "#ec4899", "#8b5cf6", "#22c55e",
    "#14b8a6", "#eab308"
  ];
  return colors[i % colors.length];
}

function openGraph(metric, title) {
  currentMetric = metric;
  document.getElementById("graphTitle").innerText = title;
  document.getElementById("graphModal").classList.remove("hidden");
  loadGraphData();
}

function closeModal() {
  document.getElementById("graphModal").classList.add("hidden");
  if (chart) chart.destroy();
}

function loadGraphData() {
  fetch(`/api/sensor-graph/?metric=${currentMetric}`)
    .then(res => res.json())
    .then(data => {
      fullData = data;

      // activate all devices
      activeDevices = {};
      Object.keys(data).forEach(d => activeDevices[d] = true);

      setupSlider();
      renderDeviceToggles();
      updateChart(sliderIndex);
    });
}

/* ---------- DEVICE TOGGLES ---------- */

function renderDeviceToggles() {
  const container = document.getElementById("deviceToggles");
  container.innerHTML = "";

  Object.keys(fullData).forEach((device, index) => {
    const btn = document.createElement("button");
    btn.innerText = device;

    const color = colorFor(index);

    btn.className =
      "px-3 py-1 rounded-full border text-sm transition";

    if (activeDevices[device]) {
      btn.style.borderColor = color;
      btn.style.color = color;
    } else {
      btn.style.borderColor = "#4b5563"; // gray-600
      btn.style.color = "#9ca3af";       // gray-400
    }

    btn.onclick = () => {
      activeDevices[device] = !activeDevices[device];
      renderDeviceToggles();
      updateChart(sliderIndex);
    };

    container.appendChild(btn);
  });
}

/* ---------- TIME SLIDER ---------- */

function setupSlider() {
  const anyDevice = Object.keys(fullData)[0];
  const length = fullData[anyDevice]?.length || 0;

  const slider = document.getElementById("timeSlider");
  slider.min = 0;
  slider.max = Math.max(0, length - 1);
  sliderIndex = slider.max;
  slider.value = sliderIndex;
}

function scrubTime(index) {
  sliderIndex = parseInt(index);
  updateChart(sliderIndex);
}

/* ---------- CHART ---------- */

function updateChart(endIndex) {
  const ctx = document.getElementById("graphCanvas").getContext("2d");
  if (chart) chart.destroy();

  let labels = [];
  const datasets = [];

  Object.entries(fullData).forEach(([device, points], index) => {
    if (!activeDevices[device]) return;

    const start = Math.max(0, endIndex - WINDOW_SIZE);
    const slice = points.slice(start, endIndex + 1);

    if (!labels.length)
      labels = slice.map(p => p.time);

    datasets.push({
      label: device,
      data: slice.map(p => p.value),
      borderColor: colorFor(index),
      borderWidth: 2,
      tension: 0.35
    });
  });

  if (!labels.length) return;

  document.getElementById("startLabel").innerText = labels[0];
  document.getElementById("endLabel").innerText = labels[labels.length - 1];

  chart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets },
    options: {
      animation: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { ticks: { color: "#aaa" } },
        y: { ticks: { color: "#aaa" } }
      }
    }
  });
}
</script>


<style>
.tile {
  cursor: pointer;
  background: #0f1f14;
  padding: 20px;
  border-radius: 16px;
  border: 1px solid #1f3a28;
  transition: border-color 0.2s;
}
.tile:hover {
  border-color: #49e619;
}
.tile h2 {
  font-size: 28px;
  font-weight: bold;
  color: white;
}
.tile p {
  color: #9ca3af;
  margin-top: 6px;
}
.tile.material-symbols-outlined {
  color: #49e619;
  font-size: 28px;
}
</style>

{% endblock %}
